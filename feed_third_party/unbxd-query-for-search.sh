mysql -h cataloging-24may2017.cjmplqztt198.ap-southeast-1.rds.amazonaws.com -unykaalive -poh1ued3phi0uh8ooPh6 --database=nykaalive1 --batch -e "SELECT e.entity_id AS entity_id, e.type_id AS type_id, e.sku AS sku, e.created_at AS created_at, at_status_default.value AS status, at_visibility_default.value AS visibility, (CASE WHEN e.type_id = \"bundle\" THEN res.display_rating ELSE res.rating_summary END) AS rating_percentage, (CASE WHEN e.type_id = \"bundle\" THEN (select SUBSTRING_INDEX(res.rating_count,\"\/\",1)) ELSE res.reviews_count END) AS review_count,Round(((CASE WHEN e.type_id = \"bundle\" THEN res.display_rating  ELSE res.rating_summary END)*5)/100) AS rating_num,(CASE WHEN cpevp.value>0 THEN cpevp.value ELSE 0 END) AS popularity,(CASE WHEN cpeif.value>0 THEN 1 ELSE 0 END) AS fbn, cpevn.value AS name, lcase(concat(cpevn.value,\" \",replace(cpevn.value,\" \",\"\"))) AS name_token,(CASE WHEN cpeier.value>0 THEN 1 ELSE 0 END) AS eretailer, cpetd.value AS description, e.attribute_set_id AS attribute_set_id,(SELECT eas.attribute_set_name FROM eav_attribute_set AS eas WHERE eas.entity_type_id = 4 AND eas.attribute_set_id = e.attribute_set_id) AS attribute_set_name,(SELECT value FROM eav_attribute_option_value AS eaov WHERE eaov.option_id = cpeib.value AND eaov.store_id = 0) AS manufacturer, cpeib.value AS brand_id, (SELECT group_concat(eaov.value) FROM eav_attribute_option_value AS eaov LEFT JOIN catalog_product_entity_varchar cpev on eaov.option_id = cpev.value and eaov.store_id =0 and cpev.store_id = 0 where cpev.attribute_id = 668 AND cpev.entity_id = e.entity_id) AS brands_v1, cpevrt.value AS rating,(SELECT group_concat(category_id separator '|') FROM catalog_category_product_index WHERE product_id = e.entity_id AND store_id = 3 AND category_id != 2) AS category_ids,(SELECT group_concat(value separator '|') FROM catalog_category_entity_varchar WHERE entity_id IN ( SELECT category_id FROM catalog_category_product_index WHERE product_id = e.entity_id AND store_id = 3 AND category_id != 2) AND attribute_id = 31) AS category,(SELECT group_concat(value separator '|') FROM catalog_category_entity_varchar WHERE entity_id IN ( SELECT category_id FROM catalog_category_product_index AS ccpi LEFT JOIN catalog_category_entity AS cce ON ccpi.category_id = cce.entity_id WHERE ccpi.product_id = e . entity_id AND ccpi.store_id = 3 AND ccpi.category_id != 2 AND cce.level = 2) AND attribute_id = 31) AS categorylevel1,(SELECT value FROM catalog_category_entity_varchar WHERE entity_id IN ( SELECT category_id FROM catalog_category_product_index AS ccpi LEFT JOIN catalog_category_entity AS cce ON ccpi.category_id = cce.entity_id WHERE ccpi.product_id = e . entity_id AND ccpi.store_id = 3 AND ccpi.category_id != 2 AND cce.level = 2) AND attribute_id = 31 limit 1) AS catlevel1name,(SELECT group_concat(value separator '|') FROM catalog_category_entity_varchar WHERE entity_id IN ( SELECT category_id FROM catalog_category_product_index AS ccpi LEFT JOIN catalog_category_entity AS cce ON ccpi.category_id = cce.entity_id WHERE ccpi.product_id = e . entity_id AND ccpi.store_id = 3 AND ccpi.category_id != 2 AND cce.level = 3) AND attribute_id = 31) AS categorylevel2,(SELECT value FROM catalog_category_entity_varchar WHERE entity_id IN ( SELECT category_id FROM catalog_category_product_index AS ccpi LEFT JOIN catalog_category_entity AS cce ON ccpi.category_id = cce.entity_id WHERE ccpi.product_id = e . entity_id AND ccpi.store_id = 3 AND ccpi.category_id != 2 AND cce.level = 3) AND attribute_id = 31 limit 1) AS catlevel2name,(SELECT group_concat(value separator '|') FROM catalog_category_entity_varchar WHERE entity_id IN ( SELECT category_id FROM catalog_category_product_index AS ccpi LEFT JOIN catalog_category_entity AS cce ON ccpi.category_id = cce.entity_id WHERE ccpi.product_id = e . entity_id AND ccpi.store_id = 3 AND ccpi.category_id != 2 AND cce.level = 4) AND attribute_id = 31) AS categorylevel3,(SELECT value FROM catalog_category_entity_varchar WHERE entity_id IN ( SELECT category_id FROM catalog_category_product_index AS ccpi LEFT JOIN catalog_category_entity AS cce ON ccpi.category_id = cce.entity_id WHERE ccpi.product_id = e . entity_id AND ccpi.store_id = 3 AND ccpi.category_id != 2 AND cce.level = 4) AND attribute_id = 31 limit 1) AS catlevel3name,(SELECT group_concat(value separator '|') FROM catalog_category_entity_varchar WHERE entity_id IN ( SELECT category_id FROM catalog_category_product_index AS ccpi LEFT JOIN catalog_category_entity AS cce ON ccpi.category_id = cce.entity_id WHERE ccpi.product_id = e . entity_id AND ccpi.store_id = 3 AND ccpi.category_id != 2 AND cce.level = 5) AND attribute_id = 31) AS categorylevel4,(SELECT value FROM catalog_category_entity_varchar WHERE entity_id IN ( SELECT category_id FROM catalog_category_product_index AS ccpi LEFT JOIN catalog_category_entity AS cce ON ccpi.category_id = cce.entity_id WHERE ccpi.product_id = e . entity_id AND ccpi.store_id = 3 AND ccpi.category_id != 2 AND cce.level = 5) AND attribute_id = 31 limit 1) AS catlevel4name,(CASE WHEN e.type_id = 'configurable' AND ( SELECT attribute_id FROM catalog_product_super_attribute WHERE product_id = e . entity_id limit 1) = 587 THEN ( SELECT concat(count(*),' Shades') FROM catalog_product_super_link AS cpsl LEFT JOIN catalog_product_entity_int AS cpei ON cpsl.product_id = cpei.entity_id AND cpei.store_id = 0 AND cpei.attribute_id = 80 WHERE cpei.value = 1 AND cpsl.parent_id = e . entity_id ) WHEN e.type_id = 'configurable' AND ( SELECT attribute_id FROM catalog_product_super_attribute WHERE product_id = e . entity_id limit 1) = 604 THEN ( SELECT concat(count(*),' Sizes') FROM catalog_product_super_link AS cpsl LEFT JOIN catalog_product_entity_int AS cpei ON cpsl.product_id = cpei.entity_id AND cpei.store_id = 0 AND cpei.attribute_id = 80 WHERE cpei.value = 1 AND cpsl.parent_id = e . entity_id ) WHEN e.type_id = 'configurable' AND ( SELECT attribute_id FROM catalog_product_super_attribute WHERE product_id = e . entity_id limit 1) = 741 THEN ( SELECT concat(count(*),' Cities') FROM catalog_product_super_link AS cpsl LEFT JOIN catalog_product_entity_int AS cpei ON cpsl.product_id = cpei.entity_id AND cpei.store_id = 0 AND cpei.attribute_id = 80 WHERE cpei.value = 1 AND cpsl.parent_id = e . entity_id ) ELSE cpevpz.value END) AS pack_size, CONCAT(CONCAT(\"http://www.nykaa.com/\",cuw.request_path),'\?ptype=product&id=' ,'',e.entity_id) AS url_path,(CASE WHEN e.type_id = 'configurable' THEN concat(\"http://www.nykaa.com/\",cuw.request_path) WHEN e.type_id = 'bundle' THEN CONCAT (CONCAT(\"http://www.nykaa.com/checkout/cart/add/uenc/,,/product/\",e.entity_id),\"/\") ELSE CONCAT (CONCAT(\"http://www.nykaa.com/checkout/cart/add/uenc/,,/product/\",e.entity_id),\"/\") END ) AS add_to_cart_url, csi.qty AS qty, csi.backorders AS backorders, css.stock_status AS is_in_stock,(CASE WHEN css.stock_status > 0 THEN 'true' ELSE 'false' END) AS availability,(CASE WHEN ( SELECT parent_id FROM catalog_product_super_link AS cpsl WHERE cpsl.product_id = e.entity_id limit 1) > 0 THEN ( SELECT parent_id FROM catalog_product_super_link AS cpsl WHERE cpsl.product_id = e.entity_id limit 1) ELSE 0 END) AS parent_id,(SELECT value FROM eav_attribute_option_value AS eaov WHERE eaov.option_id = cpeifr.value AND eaov.store_id = 0) AS formulation,(SELECT value FROM eav_attribute_option_value AS eaov WHERE eaov.option_id = cpeifn.value AND eaov.store_id = 0) AS finish,(SELECT value FROM eav_attribute_option_value AS eaov WHERE eaov.option_id = cpeicn.value AND eaov.store_id = 0) AS concern, NULL AS activedeal, NULL AS removeunbxd,(SELECT CASE WHEN discount > 0 THEN concat(discount,\" % off\") ELSE '' END FROM solr_dump_2 WHERE product_id = e.entity_id) AS discount_perc,(SELECT group_concat(eaov_tag.value separator '|') FROM catalog_product_entity_varchar cpev_tag JOIN eav_attribute_option_value eaov_tag ON cpev_tag.value = eaov_tag.option_id WHERE cpev_tag.attribute_id = 706 AND cpev_tag.entity_id = e.entity_id AND eaov_tag.store_id = 0) AS tag,(SELECT eaov_size.value FROM catalog_product_entity_int cpev_size JOIN eav_attribute_option_value eaov_size ON cpev_size.value = eaov_size.option_id WHERE cpev_size.attribute_id = 604 AND cpev_size.entity_id = e.entity_id AND eaov_size.store_id = 0) AS size,(SELECT price FROM solr_dump_2 WHERE product_id = e.entity_id) AS price,(SELECT special_price FROM solr_dump_2 WHERE product_id = e.entity_id) AS final_price,(SELECT special_price FROM solr_dump_2 WHERE product_id = e.entity_id) AS special_price,(SELECT discount FROM solr_dump_2 WHERE product_id = e.entity_id) AS discount,(SELECT image_url FROM solr_dump_2 WHERE product_id = e.entity_id) AS image,(SELECT image_url FROM solr_dump_2 WHERE product_id = e.entity_id) AS imageurl,(SELECT replace(replace(group_concat(value separator '|'),'Male','Male'),'Female','Female') FROM eav_attribute_option_value AS eaov WHERE eaov.option_id IN ( SELECT value FROM catalog_product_index_eav AS cpie WHERE cpie.store_id = 3 AND cpie.attribute_id = 655 AND cpie.entity_id = e.entity_id) AND eaov.store_id = 0) AS gender_v1,(SELECT group_concat(value separator '|') FROM eav_attribute_option_value AS eaov WHERE eaov.option_id IN ( SELECT value FROM catalog_product_index_eav AS cpie WHERE cpie.store_id = 3 AND cpie.attribute_id = 656 AND cpie.entity_id = e.entity_id) AND eaov.store_id = 0) AS concern_v1,(SELECT group_concat(value separator '|') FROM eav_attribute_option_value AS eaov WHERE eaov.option_id IN ( SELECT value FROM catalog_product_index_eav AS cpie WHERE cpie.store_id = 3 AND cpie.attribute_id = 657 AND cpie.entity_id = e.entity_id) AND eaov.store_id = 0) AS skin_type_v1,(SELECT group_concat(value separator '|') FROM eav_attribute_option_value AS eaov WHERE eaov.option_id IN ( SELECT value FROM catalog_product_index_eav AS cpie WHERE cpie.store_id = 3 AND cpie.attribute_id = 659 AND cpie.entity_id = e.entity_id) AND eaov.store_id = 0) AS formulation_v1,(SELECT group_concat(value separator '|') FROM eav_attribute_option_value AS eaov WHERE eaov.option_id IN ( SELECT value FROM catalog_product_index_eav AS cpie WHERE cpie.store_id = 3 AND cpie.attribute_id = 662 AND cpie.entity_id = e.entity_id) AND eaov.store_id = 0) AS spf_v1,(SELECT group_concat(value separator '|') FROM eav_attribute_option_value AS eaov WHERE eaov.option_id IN ( SELECT value FROM catalog_product_index_eav AS cpie WHERE cpie.store_id = 3 AND cpie.attribute_id = 664 AND cpie.entity_id = e.entity_id) AND eaov.store_id = 0) AS finish_v1,(CASE WHEN e.type_id = 'configurable' AND ( SELECT attribute_id FROM catalog_product_super_attribute WHERE product_id = e . entity_id limit 1) = 587 THEN ( SELECT group_concat(eaov_color.value separator '|') FROM catalog_product_entity_int cpev_color LEFT JOIN eav_attribute_option_value eaov_color ON cpev_color.value = eaov_color.option_id LEFT JOIN catalog_product_super_link cpsl ON cpev_color.entity_id = cpsl.product_id LEFT JOIN catalog_product_entity_int AS cpei ON cpsl.product_id = cpei.entity_id AND cpei.store_id = 0 AND cpei.attribute_id = 80 AND cpei.value = 1 WHERE cpev_color.attribute_id = 587 AND eaov_color.store_id = 0 AND cpsl.parent_id = e.entity_id) ELSE ( SELECT value FROM eav_attribute_option_value AS eaov WHERE eaov.option_id IN ( SELECT cpev_color.value FROM catalog_product_entity_int cpev_color WHERE cpev_color.attribute_id = 587 AND cpev_color.entity_id = e.entity_id) AND eaov.store_id = 0) END) AS shade,(CASE WHEN e.type_id = 'configurable' AND ( SELECT attribute_id FROM catalog_product_super_attribute WHERE product_id = e . entity_id limit 1) = 587 THEN ( SELECT group_concat(eaov.value separator '|') FROM eav_attribute_option_value AS eaov WHERE eaov.option_id IN ( SELECT cpie.value FROM catalog_product_index_eav AS cpie LEFT JOIN catalog_product_super_link cpsl ON cpie.entity_id = cpsl.product_id LEFT JOIN catalog_product_entity_int AS cpei ON cpsl.product_id = cpei.entity_id AND cpei.store_id = 0 AND cpei.attribute_id = 80 AND cpei.value = 1 WHERE cpie.store_id = 3 AND cpie.attribute_id = 658 AND cpsl.parent_id = e.entity_id) AND eaov.store_id = 0) ELSE ( SELECT group_concat(eaov.value separator '|') FROM eav_attribute_option_value AS eaov WHERE eaov.option_id IN ( SELECT value FROM catalog_product_index_eav AS cpie WHERE cpie.store_id = 3 AND cpie.attribute_id = 658 AND cpie.entity_id = e.entity_id) AND eaov.store_id = 0) END) AS color_v1,(SELECT group_concat(value separator '|') FROM eav_attribute_option_value AS eaov WHERE eaov.option_id IN ( SELECT value FROM catalog_product_index_eav AS cpie WHERE cpie.store_id = 3 AND cpie.attribute_id = 661 AND cpie.entity_id = e.entity_id) AND eaov.store_id = 0) AS preference_v1, (SELECT group_concat(ny_of.entity_id separator '|') FROM nykaa_offers ny_of WHERE find_in_set(ny_of.entity_id,cpev_offer.value) AND ny_of.enabled=1) AS offer_id, NULL AS offer_count,(SELECT value FROM eav_attribute_option_value AS eaov WHERE eaov.option_id = cpeinvg.value AND eaov.store_id = 0) AS veg_nonveg , cpeid.value AS d_sku ,(SELECT VALUE FROM catalog_product_entity_int AS cpeint where cpeint.attribute_id = '765' and cpeint.entity_id = e.entity_id) AS redirect_to_parent,NULL AS parent_url, (SELECT group_concat(ny_of.description separator '|') FROM nykaa_offers ny_of WHERE find_in_set(ny_of.entity_id,cpev_offer.value) AND ny_of.enabled=1) AS offer_name FROM catalog_product_entity AS e INNER JOIN catalog_product_entity_int AS at_status_default ON ( at_status_default . entity_id = e . entity_id ) AND ( at_status_default . attribute_id = '80') AND at_status_default . store_id = 0 INNER JOIN catalog_product_entity_int AS at_visibility_default ON ( at_visibility_default . entity_id = e . entity_id ) AND ( at_visibility_default . attribute_id = '85') AND at_visibility_default . store_id = 0 LEFT JOIN catalog_product_entity_int AS cpeid ON cpeid.entity_id = e.entity_id AND cpeid.attribute_id = 718 AND cpeid.store_id = 0 LEFT JOIN catalog_product_entity_int AS cpeisl ON cpeisl.entity_id = e.entity_id AND cpeisl.attribute_id = 714 AND cpeisl.store_id = 0 LEFT JOIN catalog_product_entity_int AS cpeiis ON cpeiis.entity_id = e.entity_id AND cpeiis.attribute_id = 755 AND cpeiis.store_id = 0 LEFT JOIN review_entity_summary AS res ON res.entity_pk_value = e.entity_id AND res.store_id = 0 LEFT JOIN catalog_product_entity_varchar AS cpevp ON cpevp.entity_id = e.entity_id AND cpevp.attribute_id = 707 AND cpevp.store_id = 0 LEFT JOIN catalog_product_entity_int AS cpeif ON cpeif.entity_id = e.entity_id AND cpeif.attribute_id = 649 AND cpeif.store_id = 0 LEFT JOIN catalog_product_entity_varchar AS cpevn ON cpevn.entity_id = e.entity_id AND cpevn.attribute_id = 56 AND cpevn.store_id = 0 LEFT JOIN catalog_product_entity_varchar AS cpev_offer ON cpev_offer.entity_id = e.entity_id AND cpev_offer.attribute_id = 678 AND cpev_offer.store_id = 0 LEFT JOIN catalog_product_entity_int AS cpeier ON cpeier.entity_id = e.entity_id AND cpeier.attribute_id = 735 AND cpeier.store_id = 0 LEFT JOIN catalog_product_entity_text AS cpetd ON cpetd.entity_id = e.entity_id AND cpetd.attribute_id = 57 AND cpetd.store_id = 0 LEFT JOIN catalog_product_entity_int AS cpeib ON cpeib.entity_id = e.entity_id AND cpeib.attribute_id = 66 AND cpeib.store_id = 0 LEFT JOIN catalog_product_entity_varchar AS cpevrt ON cpevrt.entity_id = e.entity_id AND cpevrt.attribute_id = 708 AND cpevrt.store_id = 0 LEFT JOIN catalog_product_entity_varchar AS cpevpz ON cpevpz.entity_id = e.entity_id AND cpevpz.attribute_id = 588 AND cpevpz.store_id = 0 LEFT JOIN core_url_rewrite cuw on cuw.product_id = e.entity_id and cuw.store_id = 0 LEFT JOIN cataloginventory_stock_status AS css ON css.product_id = e.entity_id LEFT JOIN cataloginventory_stock_item AS csi ON csi.product_id = e.entity_id LEFT JOIN catalog_product_entity_int AS cpeifr ON cpeifr.entity_id = e.entity_id AND cpeifr.attribute_id = 532 AND cpeifr.store_id = 0 LEFT JOIN catalog_product_entity_int AS cpeifn ON cpeifn.entity_id = e.entity_id AND cpeifn.attribute_id = 531 AND cpeifn.store_id = 0 LEFT JOIN catalog_product_entity_int AS cpeicn ON cpeicn.entity_id = e.entity_id AND cpeicn.attribute_id = 549 AND cpeicn.store_id = 0 LEFT JOIN catalog_product_entity_int AS cpeinvg ON cpeinvg.entity_id = e.entity_id AND cpeinvg.attribute_id = 696 AND cpeicn.store_id = 0 LEFT JOIN catalog_product_entity_decimal AS cpedp ON cpedp.entity_id = e.entity_id AND cpedp.attribute_id = 60 AND cpedp.store_id = 0 LEFT JOIN catalog_product_entity_decimal AS cpedsp ON cpedsp.entity_id = e.entity_id AND cpedsp.attribute_id = 61 AND cpedsp.store_id = 0 WHERE at_status_default.value = '1' AND ( cpeiis.value IS NULL OR cpeiis.value = 1) AND ( cpeisl.value IS NULL OR cpeisl.value = 0) AND ( cpeid.value IS NULL OR cpeid.value = 0 OR cpeid.value = 1 ) and cuw.category_id is null;" | sed 's/"/""/g;s/\t/","/g;s/^/"/;s/$/"/;s/\n//g' > /var/www/nykaa/media/feed/unbxd_feed_new.csv